#define _CRT_SECURE_NO_WARNINGS
#define _WINSOCK_DEPRECATED_NO_WARNINGS
#include <WinSock2.h>  
#include <stdio.h>
#pragma comment(lib,"ws2_32.lib")

HANDLE stdMutex;

DWORD WINAPI ClientThread(LPVOID lpParam) {
	SOCKET ss = *((SOCKET*)lpParam);
	DWORD cid;
	int retVal;
	char *recvBuf = malloc(4096);
	char *sendBuf = malloc(4096);

	cid = GetCurrentThreadId();
	printf("%08X.#>: weclome!!! ^-^\n", cid);
	while (1)
	{
		//接收消息
		printf("%08X.#>:\n",cid);
		memset(recvBuf, 0, 4096);
		retVal = recv(ss, recvBuf, 4096, 0);
		//判断客户端是否关闭连接
		if (SOCKET_ERROR == retVal) {
			printf("failed !\n");
			break;
		}
		printf("%s\n", recvBuf);
		tag:
		printf("%08X.#>: ", cid);
		fflush(stdin);
		memset(sendBuf, 0, 4096);
		gets(sendBuf);

		if (strcmp(sendBuf, "cls") == 0){
			system("cls");
			goto tag;
		}
		if (strcmp(sendBuf, "exit") == 0){
			send(ss, "exit", 4, 0);
			break;
		}
		send(ss, sendBuf, strlen(sendBuf), 0);
	}
	printf("%08X.#>: Good Bye -_- \nwait next one to connect....\n", cid);
	closesocket(ss);
	free(recvBuf);
	free(sendBuf);
	return 0;
}



int main()
{
	//定义需要使用的变量
	WSADATA wsaData;

	SOCKET sockListen, sockConn;
	SOCKADDR_IN ListenAddr, ConnAddr;

	//准备环境
	WSAStartup(MAKEWORD(2, 2), &wsaData);

	//创建一个电话
	sockListen = socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);

	if (sockListen == INVALID_SOCKET) {
		printf("socket failed\n");
	}

	//买一个电话卡
	ListenAddr.sin_addr.S_un.S_addr = INADDR_ANY;  //如果对ip地址不关心的话，可设置为 INADDR_ANY
	ListenAddr.sin_family = AF_INET;
	ListenAddr.sin_port = htons(8889);

	//把电话卡插入电话
	if (SOCKET_ERROR == bind(sockListen, (SOCKADDR*)&ListenAddr, sizeof(SOCKADDR))) {

		printf("bind is error with %d\n", WSAGetLastError());
	}

	//电话开机
	printf("00000000.#> i am working ^-^ \n");
	if (SOCKET_ERROR == listen(sockListen, 5)) {

		printf("listen is error with %d\n", WSAGetLastError());
	}

	int socklen = sizeof(ConnAddr);

	while (1) {
		//接听电话
		sockConn = accept(sockListen, (SOCKADDR*)&ConnAddr, &socklen);
		//每接收一个链接，就创建一个线程来处理相应的消息
		CreateThread(NULL, 0, ClientThread, (LPVOID)&sockConn, NULL, NULL);
	}

	//关闭套接字和终止套接字库的使用
	closesocket(sockListen);
	WSACleanup();
	return 0;
}
