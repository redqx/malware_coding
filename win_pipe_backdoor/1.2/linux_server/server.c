#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <arpa/inet.h>
#include <pthread.h>
#include <locale.h>
int stri_memcmp(char* x, char* y, int len) {
    int i;
    char* x1 = malloc(len + 1);
    char* y1 = malloc(len + 1);

    memcpy(x1, x, len);
    memcpy(y1, y, len);

    for (i = 0; i < len; i++) {
        x1[i] = x1[i] | 32;
        y1[i] = y1[i] | 32;
    }
    return memcmp(x1, y1, len);

}
void* clientThread(void* arg) {
    int ss = *((int*)arg);
    pthread_t tid = pthread_self();
    int retVal;
    char* recvBuf = malloc(4096);
    char* sendBuf = malloc(4096);

    printf("%08lx.#>: Welcome!!! ^-^\n", (unsigned long)tid);
    while (1) {
        //接收消息
        memset(recvBuf, 0, 4096);
        retVal = recv(ss, recvBuf, 4096, 0);
        //判断客户端是否关闭连接
        if (retVal <= 0) {
            printf("Failed !\n");
            break;
        }
        printf("%s\n", recvBuf);
    tag:
        printf("%08lx.#>: ", (unsigned long)tid);
        fflush(stdin);
        memset(sendBuf, 0, 4096);
        fgets(sendBuf, 4096, stdin);

        if (stri_memcmp(sendBuf, "cls", 3) == 0) {
            system("clear");
            goto tag;
        }
        if (stri_memcmp(sendBuf, "exit", 4) == 0) {
            send(ss, "exit", 4, 0);
            break;
        }
        send(ss, sendBuf, strlen(sendBuf), 0);
    }
    printf("%08lx.#>: Good Bye -_- \nWait for the next one to connect....\n", (unsigned long)tid);
    close(ss);
    free(recvBuf);
    free(sendBuf);
    return NULL;
}

int main(int argc, char* argv[]) {



    //定义需要使用的变量
    int sockListen, sockConn;
    struct sockaddr_in ListenAddr, ConnAddr;

    int tmpNum;
    char* endptr;
    if (argc != 2) {
        printf("USAGE: %s port\n", argv[0]);
        return -1;
    }

    tmpNum = strtol(argv[1], &endptr, 10);

    if (endptr == argv[1]) {
        printf("无效的输入\n");
        return -1;
    }
    else if (*endptr != '\0') {
        printf("转换到非数字字符：%c\n", *endptr);
        return -1;
    }

    //setlocale(LC_ALL, "en_US.UTF-8");
    setlocale(LC_CTYPE, "en_US.UTF-8");

    printf("00000000.#> work with 127.0.0.1 %d\n", tmpNum);
    //创建一个电话
    sockListen = socket(AF_INET, SOCK_STREAM, 0);

    if (sockListen == -1) {
        perror("Socket creation failed");
        return -1;
    }

    //买一个电话卡
    ListenAddr.sin_addr.s_addr = INADDR_ANY;  //如果对ip地址不关心的话，可设置为 INADDR_ANY
    ListenAddr.sin_family = AF_INET;
    ListenAddr.sin_port = htons(tmpNum);

    //把电话卡插入电话
    if (bind(sockListen, (struct sockaddr*)&ListenAddr, sizeof(ListenAddr)) == -1) {

        perror("Bind is error");
        close(sockListen);
        return -1;
    }

    //电话开机
    printf("00000000.#> I am working ^-^ \n");
    if (listen(sockListen, 5) == -1) {

        perror("Listen is error");
        close(sockListen);
        return -1;
    }

    socklen_t socklen = sizeof(ConnAddr);

    while (1) {
        //接听电话
        sockConn = accept(sockListen, (struct sockaddr*)&ConnAddr, &socklen);
        //每接收一个链接，就创建一个线程来处理相应的消息
        pthread_t tid;
        pthread_create(&tid, NULL, clientThread, &sockConn);
        pthread_join(tid, NULL);
    }

    //关闭套接字
    close(sockListen);

    return 0;
}
